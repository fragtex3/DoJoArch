#!/bin/bash

################################################################################
#                      CUSTOM ARCH LINUX - DOJO INSTALLER                      #
#                           Version 1.0 - Master Edition                        #
#                                                                               #
#  Installation script fÃ¼r Custom Arch Linux mit eigenem Hacking-Toolkit      #
#  FÃ¼hrt automatisiert alle Dependencies, Configs und Tools aus               #
################################################################################

set -e  # Exit on error

# === COLORS & FORMATTING ===
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# === LOGGING FUNCTIONS ===
log_info() {
    echo -e "${CYAN}[i]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[âœ“]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

log_error() {
    echo -e "${RED}[âœ—]${NC} $1"
}

log_section() {
    echo -e "\n${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘${NC} $1"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
}

# === SYSTEM CHECK ===
check_system() {
    log_section "SYSTEM CHECK"
    
    if ! grep -q "Arch" /etc/os-release; then
        log_error "This script requires Arch Linux or Arch-based distribution"
        exit 1
    fi
    
    if ! command -v pacman &> /dev/null; then
        log_error "pacman not found. Are you really on Arch?"
        exit 1
    fi
    
    if [[ $EUID -ne 0 ]]; then
        log_warning "This script should be run as root (sudo)"
        log_info "Attempting to escalate privileges..."
        exec sudo "$0" "$@"
    fi
    
    log_success "System check passed"
}

# === PACKAGE INSTALLATION ===
install_packages() {
    log_section "INSTALLING PACKAGES"
    
    # Core WM & Display
    local core_packages=(
        "i3-wm"
        "i3lock"
        "i3blocks"
        "dmenu"
        "rofi"
        "feh"
        "picom"
        "xclip"
        "xsel"
        "xorg-xrandr"
    )
    
    # Terminal & Shells
    local terminal_packages=(
        "kitty"
        "zsh"
        "tmux"
        "bash-completion"
    )
    
    # Development
    local dev_packages=(
        "git"
        "base-devel"
        "rustup"
        "python"
        "python-pip"
        "nodejs"
        "npm"
        "code"
        "vim"
        "neovim"
    )
    
    # Utilities
    local util_packages=(
        "dunst"
        "pavucontrol"
        "alsa-utils"
        "pulseaudio"
        "pulseaudio-alsa"
        "network-manager"
        "blueman"
        "light"
        "flameshot"
        "thunar"
        "thunar-volman"
        "tumbler"
        "gvfs"
    )
    
    # Hacking Tools (Basic)
    local security_packages=(
        "nmap"
        "netcat"
        "tcpdump"
        "wireshark-cli"
        "metasploit"
        "sqlmap"
        "hydra"
        "hashcat"
        "john"
        "aircrack-ng"
        "burp-suite"
    )
    
    # Monitoring & Analysis
    local monitor_packages=(
        "htop"
        "iotop"
        "nethogs"
        "glances"
        "lsof"
        "strace"
        "ltrace"
    )
    
    # Fonts
    local font_packages=(
        "ttf-jetbrains-mono"
        "ttf-hack"
        "ttf-fira-code"
        "noto-fonts"
        "noto-fonts-emoji"
    )
    
    # Combine all packages
    local all_packages=(
        "${core_packages[@]}"
        "${terminal_packages[@]}"
        "${dev_packages[@]}"
        "${util_packages[@]}"
        "${security_packages[@]}"
        "${monitor_packages[@]}"
        "${font_packages[@]}"
    )
    
    # Update system
    log_info "Updating system..."
    pacman -Syu --noconfirm
    
    # Install packages
    log_info "Installing ${#all_packages[@]} packages..."
    for package in "${all_packages[@]}"; do
        if pacman -Qi "$package" &> /dev/null; then
            log_success "$package already installed"
        else
            log_info "Installing $package..."
            pacman -S --noconfirm "$package" || log_warning "Failed to install $package"
        fi
    done
}

# === CONFIGURATION FILES ===
setup_configs() {
    log_section "SETTING UP CONFIGURATION FILES"
    
    local config_dir="$HOME/.config"
    local dojo_dir="$config_dir/dojo"
    
    # Create directories
    mkdir -p "$dojo_dir"
    mkdir -p "$config_dir/i3"
    mkdir -p "$config_dir/kitty"
    mkdir -p "$config_dir/rofi"
    mkdir -p "$config_dir/dunst"
    mkdir -p "$config_dir/picom"
    mkdir -p "$config_dir/i3blocks"
    
    log_info "Creating i3 configuration..."
    # i3 config wÃ¼rde hier kopiert werden
    # cp ./i3_config "$config_dir/i3/config"
    
    log_success "Configuration directories created"
}

# === SHELL CONFIGURATION ===
setup_shell() {
    log_section "SETTING UP SHELL ENVIRONMENT"
    
    # ZSH installation
    if ! command -v zsh &> /dev/null; then
        log_info "Installing Zsh..."
        pacman -S --noconfirm zsh zsh-completions
    fi
    
    # Oh-my-zsh
    if [ ! -d "$HOME/.oh-my-zsh" ]; then
        log_info "Installing Oh-my-zsh..."
        sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
    fi
    
    # Change shell to ZSH
    if [ "$SHELL" != "$(which zsh)" ]; then
        log_info "Changing default shell to Zsh..."
        chsh -s "$(which zsh)" "$(whoami)"
    fi
    
    log_success "Shell environment configured"
}

# === RUST INSTALLATION ===
setup_rust() {
    log_section "SETTING UP RUST ENVIRONMENT"
    
    if ! command -v rustc &> /dev/null; then
        log_info "Installing Rust toolchain..."
        rustup default stable
        rustup component add rls rust-analysis
    fi
    
    log_success "Rust environment ready"
}

# === CUSTOM STARTUP SCRIPTS ===
create_startup_scripts() {
    log_section "CREATING STARTUP SCRIPTS"
    
    local dojo_dir="$HOME/.config/dojo"
    
    # Main startup script
    cat > "$dojo_dir/startup.sh" << 'EOF'
#!/bin/bash
# Custom DOJO Startup Script

# Set keyboard layout
setxkbmap de

# Load environment variables
if [ -f ~/.config/dojo/env.sh ]; then
    source ~/.config/dojo/env.sh
fi

# Initialize custom tools
if [ -d ~/.local/share/dojo/tools ]; then
    export PATH="$PATH:$HOME/.local/share/dojo/tools"
fi

# Load custom aliases
if [ -f ~/.config/dojo/aliases.sh ]; then
    source ~/.config/dojo/aliases.sh
fi

echo "DOJO System initialized"
EOF
    
    chmod +x "$dojo_dir/startup.sh"
    
    # Panel startup script (placeholder)
    cat > "$dojo_dir/panel.sh" << 'EOF'
#!/bin/bash
# Custom Panel Launcher
# This will be replaced by our custom panel

# For now, using i3blocks
i3blocks -c ~/.config/i3blocks/config &
EOF
    
    chmod +x "$dojo_dir/panel.sh"
    
    log_success "Startup scripts created"
}

# === CUSTOM ALIASES ===
create_aliases() {
    log_section "SETTING UP CUSTOM ALIASES"
    
    local dojo_dir="$HOME/.config/dojo"
    
    cat > "$dojo_dir/aliases.sh" << 'EOF'
#!/bin/bash
# Custom DOJO Aliases

# Navigation
alias ll='ls -lah'
alias la='ls -A'
alias l='ls -CF'
alias ..='cd ..'
alias ...='cd ../..'

# Git
alias gs='git status'
alias ga='git add .'
alias gc='git commit -m'
alias gp='git push'
alias gl='git log --oneline'

# Security Tools
alias nmap-scan='nmap -sV -sC -A'
alias nmap-aggressive='nmap -A -T4'
alias port-scan='nmap -p- -T4'
alias web-recon='whatweb -a 3'

# Development
alias pya='python -m venv venv && source venv/bin/activate'
alias pyc='python -m py_compile'
alias pyi='pip install'

# System
alias update='sudo pacman -Syu'
alias clean='sudo pacman -Sc && sudo pacman -Rns $(pacman -Qdtq)'
alias sysinfo='uname -a && cat /proc/cpuinfo | grep "model name" | head -1'

# Custom DOJO tools (will be extended)
alias dojo-update='cd ~/dojo && git pull && ./install.sh'
EOF
    
    log_success "Aliases configured"
}

# === THEME & AESTHETICS ===
setup_theme() {
    log_section "SETTING UP DOJO THEME"
    
    local dojo_dir="$HOME/.config/dojo"
    
    # Rofi theme
    mkdir -p "$HOME/.config/rofi"
    cat > "$HOME/.config/rofi/dojo-dark.rasi" << 'EOF'
* {
    bg-col:  #0a0e27;
    bg-col-light: #1a1f3a;
    border-col: #00d9ff;
    selected-col: #2a2f4a;
    fg-col: #e0e6ff;
    fg-col2: #a0aacf;
    grey: #505050;
    width: 600;
    font: "JetBrains Mono 11";
}

element-text, element-icon , mode-switcher {
    background-color: inherit;
    text-color:      inherit;
}

window {
    height: 360px;
    border: 3px;
    border-color: @border-col;
    background-color: @bg-col;
}

mainbox {
    background-color: @bg-col;
}

inputbar {
    children: [prompt, search];
    border: 1px;
    border-color: @border-col;
    background-color: @bg-col-light;
}

prompt {
    background-color: @bg-col;
    text-color: @fg-col;
    padding: 6px;
    margin: 0px 0px 0px 10px;
}

textbox-prompt-colon {
    str: ":";
}

search {
    text-color: @fg-col;
    background-color: @bg-col;
    padding: 6px;
}

listview {
    border: 0px 0px 1px 0px;
    border-color: @border-col;
    margin: 10px 0px 0px 0px;
    lines: 8;
    columns: 1;
    background-color: @bg-col;
}

element {
    border: 0px;
    padding: 5px 10px;
    background-color: @bg-col;
    text-color: @fg-col2;
}

element-icon {
    size: 25px;
}

element.selected {
    background-color: @selected-col;
    text-color: @fg-col;
    border: 1px solid @border-col;
}

mode-switcher {
    border: 1px 0px 0px 0px;
    border-color: @border-col;
    background-color: @bg-col;
}

button {
    padding: 5px 15px;
    border: 0px;
    border-radius: 5px;
    background-color: @bg-col-light;
    text-color: @fg-col;
    cursor: pointer;
}

button.selected {
    background-color: @border-col;
    text-color: @bg-col;
}

message {
    background-color: @bg-col;
    border: 1px solid @border-col;
    border-radius: 5px;
    padding: 10px;
    margin: 10px;
}

textbox {
    padding: 6px;
    margin: 20px 20px 20px 20px;
    text-color: @fg-col2;
    background-color: @bg-col;
}
EOF
    
    log_success "Rofi theme configured"
}

# === GIT REPOSITORY SETUP ===
setup_repository() {
    log_section "INITIALIZING GIT REPOSITORY"
    
    local dojo_dir="$HOME/dojo"
    
    if [ ! -d "$dojo_dir" ]; then
        mkdir -p "$dojo_dir"
        cd "$dojo_dir"
        git init
        
        # Create README
        cat > README.md << 'EOF'
# Custom Arch Linux - DOJO Edition

Eine eigenstÃ¤ndige Linux-Distribution auf Basis von Arch mit Custom-Tools und eigenem Look.

## Features

- Custom i3 Window Manager Configuration
- EigenstÃ¤ndiges Panel-System
- Integriertes Hacking-Toolkit
- Automatisierter Installer
- Zsh + Tmux Setup
- Umfangreiche Keyboard-Shortcuts

## Installation

```bash
sudo ./install.sh
```

## Struktur

- `/tools` - Custom Security Tools
- `/.config` - Konfigurationsdateien
- `/scripts` - Automatisierungsskripte

## Lizenz

MIT License - FÃ¼r persÃ¶nlichen und professionellen Gebrauch

EOF
        
        git add .
        git commit -m "Initial DOJO commit"
        
        log_success "Git repository initialized"
    fi
}

# === FINAL SETUP ===
final_setup() {
    log_section "FINAL SETUP"
    
    log_info "Setting permissions..."
    chmod +x ~/.config/dojo/*.sh
    
    log_info "Creating desktop files for quick launch..."
    mkdir -p ~/.local/share/applications
    
    log_success "Installation complete!"
}

# === MAIN EXECUTION ===
main() {
    clear
    
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘     CUSTOM ARCH LINUX - DOJO INSTALLER v1.0              â•‘"
    echo "â•‘                                                            â•‘"
    echo "â•‘  Professionelle Hacking-Distro auf Arch-Basis            â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}\n"
    
    read -p "Press Enter to continue installation or Ctrl+C to abort..."
    
    check_system
    install_packages
    setup_configs
    setup_shell
    setup_rust
    create_startup_scripts
    create_aliases
    setup_theme
    setup_repository
    final_setup
    
    echo -e "\n${GREEN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘           INSTALLATION ERFOLGREICH ABGESCHLOSSEN!         â•‘"
    echo "â•‘                                                            â•‘"
    echo "â•‘  NÃ¤chste Schritte:                                        â•‘"
    echo "â•‘  1. Neustarten: reboot                                    â•‘"
    echo "â•‘  2. i3 beim Login wÃ¤hlen                                  â•‘"
    echo "â•‘  3. Mod+d drÃ¼cken zum Starten                             â•‘"
    echo "â•‘                                                            â•‘"
    echo "â•‘  Willkommen im DOJO! ðŸ¥‹                                   â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}\n"
}

main "$@"